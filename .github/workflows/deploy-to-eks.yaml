name: Build & Deploy to EKS
'on':
  push:
    branches:
      - main
permissions:
  id-token: write
  contents: read
env:
  EKS_CLUSTER: extravagant-sculpture-1658356084
  EKS_REGION: us-west-2
jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Clone repo
        uses: actions/checkout@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: 'arn:aws:iam::853701244726:role/github_action_role'
          aws-region: us-west-2
      - name: Check AWS authentication
        run: aws sts get-caller-identity
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      - name: Install kubectl
        run: >
          curl -LO "https://dl.k8s.io/release/$(curl -L -s
          https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"

          curl -LO "https://dl.k8s.io/$(curl -L -s
          https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256"

          echo "$(<kubectl.sha256) kubectl" | sha256sum --check



          sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

          kubectl version --client
      - name: Install Skaffold
        run: >
          curl -Lo skaffold
          https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64
          && \

          sudo install skaffold /usr/local/bin/

          skaffold version
      - name: Config current context
        run: kubectl config current-context
      - name: Cache skaffold image builds & config
        uses: actions/cache@v2
        with:
          path: ~/.skaffold/
          key: 'fixed-${{ github.sha }}'
      - name: Connect to EKS cluster
        run: aws eks --region $EKS_REGION update-kubeconfig --name $EKS_CLUSTER
      - name: Build and then deploy to EKS cluster with Skaffold
        run: skaffold run
      - name: Verify the deployment
        run: kubectl get pods
